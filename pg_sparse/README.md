<h1 align="center">
  <img src="../docs/logo/pg_sparse.svg" alt="pg_sparse" width="500px"></a>
<br>
</h1>

# Overview

`pg_sparse` is an extension that enables approximate nearest neighbors (ANN) search over
sparse vectors in Postgres using HNSW. `pg_sparse` is to sparse vectors what `pgvector` is to dense vectors.

Generated by sparse embedding models like SPLADE, sparse vectors are different from dense vectors because they contain significantly more entries,
most of which are zero. Storing raw sparse vectors in Postgres and calculating distances between them incurs extremely high storage and
performance costs. `pg_sparse` solves this by compressing the sparse vectors and constructing an HNSW graph over the compressed vector
representations.

## Usage

This toy example demonstrates the usage of `pg_sparse`.

```sql
CREATE EXTENSION pg_sparse;

CREATE TABLE mock_items (
    id SERIAL PRIMARY KEY,
    description TEXT,
    sparse_embedding SPARSE
);

INSERT INTO mock_items (description, sparse_embedding)
VALUES
    ('Ergonomic metal keyboard', '[0,1,0,1]'),
    ('Plastic Keyboard', '[0,2,0,2]');

-- Optional: Create an HNSW index for ANN search
CREATE INDEX ON mock_items USING sparse_hnsw(sparse_embedding);

SELECT * FROM mock_items ORDER BY sparse_embedding <==> '[0,3,0,3]' LIMIT 1;
```

## Installation

### From Self-Hosted PostgreSQL

If you are self-hosting Postgres and would like to use the extension within your existing Postgres, follow these steps:

#### Debian/Ubuntu

We provide prebuilt binaries for Debian-based Linux, currently only for PostgreSQL 15 (more versions coming soon). To install `pg_sparse`, follow these steps:

```bash
# Download the .deb file
wget "$(curl -s "https://api.github.com/repos/paradedb/paradedb/releases/latest" | grep "browser_download_url.*pg_sparse.*.deb" | cut -d : -f 2,3 | tr -d \")" -O pg_sparse.deb

# Install the .deb file
sudo apt-get install pg_sparse.deb
```

ParadeDB collects anonymous telemetry to help us understand how many people are using the project. You can opt-out of telemetry by setting `export TELEMETRY=false` (or unsetting the variable) in your shell or in your `~/.bashrc` file before running the extension.

#### macOS and Windows

We don't suggest running production workloads on macOS or Windows. As a result, we don't provide prebuilt binaries for these platforms. If you are running Postgres on macOS or Windows and want to install `pg_sparse`, please follow the [development](#development) instructions, but do `cargo pgrx install --release` instead of `cargo pgrx run`. This will build the extension from source and install it in your Postgres instance.

You can then create the extension in your database by running:

```sql
CREATE EXTENSION pg_sparse;
```

Note: If you are using a managed Postgres service like Amazon RDS, you will not be able to install `pg_sparse` until the Postgres service explicitly supports it.

### From ParadeDB

`pg_sparse` is in beta. As a result, it has not yet been added to ParadeDB.

## HNSW Index Creation

Creating an HNSW index can significantly improve sparse vector search times over large datasets.

```sql
CREATE INDEX ON mock_items
USING sparse_hnsw(sparse_embedding)
WITH (ef_search=20, ef_construction=20, m=10);
```

### Index Options

- `ef_search`: Adjusts the trade-off between search speed and accuracy by controlling the number of candidate nodes considered during the query time in a proximity graph. A higher `ef_search` leads to more accurate results
  but longer query times. We recommend setting `ef_search` at least the number of results you want returned. Minimum is `1` and maximum is `1000`.

- `ef_construction`: Controls the size of the dynamic candidate list during the index construction. A higher `ef`
  search increases index creation time. Minimum is `4` and maximum is `1000`.

- `m`: Defines the maximum number of edges per point in the base layer, influencing the graph's connectivity and the algorithm's efficiency and accuracy during index construction. A higher `m` increases the index size and
  creation time. Minimum is `2` and maximum is `100`.

Once an HNSW index is created, the Postgres query planner dynamically decides whether to use the index based
on factors like table size. To force usage of the HNSW index, you can disable sequential scans:

```sql
SET enable_seqscan = off;
```

## Sparse Vector Search

Currently, only sparse cosine distance is supported. Sparse dot product is coming soon.

```sql
SELECT text FROM mock_items ORDER BY sparse_embedding <==> `[0,1,0,1]` LIMIT 1;
```

When using the HNSW index, setting a smaller `LIMIT` leads to faster query times.

## How HNSW Works

HNSW (Hierarchical Navigable Small World) is an algorithm for approximate nearest neighbor search. In the context
of Postgres, the HNSW index enables faster sparse vector query times by reducing the number of vectors that
need to examined.

At index creation time, the algorithm constructs a hierarchy of layered graphs where each layer represents a different resolution of the data. In each layer, connections are established between data points (vectors).

At query time, HNSW starts from the top layer of the hierarchy and progressively descends through the layers. It navigates the small-world network via the connections established during the construction phase, ensuring that the search is focused on the non-sparse regions of the vector space.

## Development

### Prerequisites

Before developing the extension, ensure that you have Rust installed
(version >1.70), ideally via `rustup` (we've observed issues with installing Rust
via Homebrew on macOS).

Then, install and initialize pgrx:

```bash
cargo install cargo-pgrx --version 0.11.0
cargo pgrx init
```

### Running the Extension

First, start pgrx:

```bash
cargo pgrx run
```

This will launch an interactive connection to Postgres. Inside Postgres, create
the extension by running:

```sql
CREATE EXTENSION pg_sparse;
```

Now, you have access to all the extension functions.

### Modifying the Extension

If you make changes to the extension code, follow these steps to update it:

1. Recompile the extension:

```bash
cargo pgrx run
```

2. Recreate the extension to load the latest changes:

```sql
DROP EXTENSION pg_sparse;
CREATE EXTENSION pg_sparse;
```

### Testing

To run the unit test suite, use the following command:

```bash
cargo pgrx test
```

This will run all unit tests defined in `/src`. To add a new unit test, simply add
tests inline in the relevant files, using the `#[cfg(test)]` attribute.

To run the integration test suite, run:

```bash
./test/runtests.sh -p threaded
```

This will create a temporary database, initialize it with the SQL commands defined
in `fixtures.sql`, and run the tests in `/test/sql` against it. To add a new test,
simply add a new `.sql` file to `/test/sql` and a corresponding `.out` file to
`/test/expected` for the expected output, and it will automatically get picked up
by the test suite.

## License

`pg_sparse` is licensed under the [GNU Affero General Public License v3.0](../LICENSE).
