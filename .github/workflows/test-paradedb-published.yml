name: Test ParadeDB (Published)

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches:
      - main
      - dev
    paths:
      - ".github/workflows/test-paradedb.yml"
      - "docker/**"
  workflow_dispatch:

concurrency:
  group: test-paradedb-published-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  test-paradedb-container:
    name: Test ParadeDB in Container
    runs-on: ubicloud-standard-2
    container:
      image: paradedb/paradedb:latest
      env:
        POSTGRES_USER: postgres
        POSTGRES_PASSWORD: mypassword
        POSTGRES_DB: postgres
      options: --name paradedb-test-container --user root

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Verify ParadeDB Environment
        run: |
          echo "Waiting for ParadeDB to start..."
          sleep 30

          echo "Testing ParadeDB running inside the container."
          echo "Container hostname: $(hostname)"
          echo "Checking if ParadeDB is running..."
          ps aux | grep postgres

          # Example: Verify ParadeDB status using psql
          psql -U postgres -d postgres

      - name: Run ParadeDB Commands
        run: |
          # Replace this with ParadeDB-specific commands or queries
          echo "Running test query..."
          psql -U postgres -d testdb -c "SELECT 'ParadeDB is running!' AS message;"
